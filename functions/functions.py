from datetime import date, datetime, timedelta
from typing import List, Dict, Union, Tuple

from aiogram.types import InputMediaPhoto
from loguru import logger
from pydantic.types import Decimal

from config_data.config import MONTH_NAME, BOT_NAME

HISTORY_DISPLAY_LIMIT = 15


def get_start_date() -> Dict[str, date]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞ –¥–ª—è —Ä–∞—Å—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ –∫–æ–º–∞–Ω–¥–µ /start.
    –ù–∞–ø—Ä–∏–º–µ—Ä, —Å–µ–≥–æ–¥–Ω—è 2 —á–∏—Å–ª–æ (—Å–±), —Ç–æ –Ω—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –¥–∞–Ω–Ω—ã–µ —Å –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏, –∞ –Ω–µ —Å –Ω–∞—á–∞–ª–∞ –º–µ—Å—è—Ü–∞.

    :return: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞—Ç–∞–º–∏ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–æ–≤.
    """
    try:
        today = date.today()
        week_number = today.isocalendar()[1]
        month = today.month
        year = today.year

        first_day_of_week = datetime.strptime(
            f"{year}-W{week_number}-1", "%Y-W%W-%w"
        ).date()
        first_day_of_month = datetime.strptime(f"{year}-{month}-1", "%Y-%m-%d").date()
        last_day_of_week = first_day_of_week + timedelta(days=6)

        end_date = (
            first_day_of_month
            if first_day_of_month < first_day_of_week
            else first_day_of_week
        )

        logger.debug(f"–°–æ–±—Ä–∞–ª–∏ –¥–∞—Ç—ã")

        return {
            "today": today,
            "end_date": end_date,
            "start_week": first_day_of_week,
            "end_week": last_day_of_week,
            "start_month": first_day_of_month,
        }

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")


def calculate_statistics(
    query: List[Dict[str, Union[str, float]]],
    first_day_of_week: date,
    last_day_of_week: date,
    first_day_of_month: date,
) -> Dict[str, List[float]]:
    """
    –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

    :param query: –°–ø–∏—Å–æ–∫ –¥–∞–Ω–Ω—ã—Ö –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö.
    :param first_day_of_week: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏.
    :param last_day_of_week: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏.
    :param first_day_of_month: –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞.
    :return: –°–ª–æ–≤–∞—Ä—å —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π.
    """
    try:
        today = date.today()

        today_result = []
        week_result = []
        month_result = []

        for elem in query:
            if elem.get("transaction_date") >= first_day_of_month:
                month_result.append(float(elem.get("amount")))
                if elem.get("transaction_date") == today:
                    today_result.append(float(elem.get("amount")))

        for elem in query:
            if first_day_of_week <= elem.get("transaction_date") <= last_day_of_week:
                week_result.append(float(elem.get("amount")))

        result = {
            "today": today_result,
            "week": week_result,
            "month": month_result,
        }

        logger.debug(f"–°–æ–±—Ä–∞–ª–∏ —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏")

        return result
    except Exception as ex:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {ex}")
        return {}


def create_history_text(text: str, history: List[Dict[str, Union[str, float]]]) -> str:
    """
    –°–æ–∑–¥–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

    :param text: –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç.
    :param history: –°–ø–∏—Å–æ–∫ –¥–∞–Ω–Ω—ã—Ö –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö.
    :return: –ò—Ç–æ–≥–æ–≤—ã–π —Ç–µ–∫—Å—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.
    """
    today_date = date.today()
    date_list = []

    history_to_remove = []
    for day_history in reversed(history[:HISTORY_DISPLAY_LIMIT]):
        user_date = day_history["transaction_date"]
        if user_date not in date_list:
            date_list.append(user_date)
            user_date = (
                "–°–µ–≥–æ–¥–Ω—è" if user_date == today_date else user_date.strftime("%d.%m.%Y")
            )
            text += f"üìÜ*{user_date}*\n-----------\n"

        summ = day_history.get("amount")
        descr = day_history.get("description")
        history_id = day_history.get("id")
        category = day_history.get("category_name")

        text += f"   {float(summ)} ‚ÇΩ | *{category}*\n"
        if descr != "":
            text += f"   –û–ø–∏—Å–∞–Ω–∏–µ: {descr}\n"

        text += (
            f"   ‚úèÔ∏è\n"
            f"   [–ò–∑–º–µ–Ω–∏—Ç—å](https://telegram.me/{BOT_NAME}?start=change{history_id})\n"
            f"   [–£–¥–∞–ª–∏—Ç—å](https://telegram.me/{BOT_NAME}?start=del{history_id})\n"
            f"-----------\n"
        )

        history_to_remove.append(day_history)

    for item in history_to_remove:
        history.remove(item)
    return text


def text_of_stat(history_list: Dict) -> Tuple[str, Dict[str, Dict[str, int]]]:
    """
    –°–æ–∑–¥–∞–µ—Ç —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ø–∏—Å–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏.

    :param history_list: –°–ª–æ–≤–∞—Ä—å –¥–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.
    :return: –ò—Ç–æ–≥–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.
    """
    date_list = []
    data_for_graphic = {}
    text = ""

    sorted_data = sorted(
        history_list, key=lambda x: datetime.strptime(x["year_month"], "%Y-%m")
    )

    for history in sorted_data:
        year_month = history["year_month"]
        year, month = year_month.split("-")
        month_name = MONTH_NAME[int(month)]

        if year_month not in date_list:
            if text != "":
                text = text_of_stat_generate(text, income_stat, expense_stat)

            text += f"\nüîπ*{month_name} {year}*\n\n"
            date_list.append(year_month)
            income_stat = 0
            expense_stat = 0

        summ = float(history["amount"])
        if summ > 0:
            income_stat += summ
        else:
            expense_stat += summ

        text += f"  üî∏{history['category_name']}: {summ} ‚ÇΩ\n"
        data_for_graphic[month_name] = {"Income": income_stat, "Expense": expense_stat}

    text = text_of_stat_generate(text, income_stat, expense_stat)

    if not text:
        text = f"\n–í —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥ —Ç—Ä–∞—Ç –Ω–µ –±—ã–ª–æ"

    return text, data_for_graphic


def text_of_stat_generate(text, income_stat, expense_stat):
    text += (
        f"\n  üí∞–í—Å–µ–≥–æ –¥–æ—Ö–æ–¥: {income_stat}\n"
        f"  üîª–í—Å–µ–≥–æ —Ä–∞—Å—Ö–æ–¥: {expense_stat}\n"
        f"  üî∞–û—Å—Ç–∞–ª–æ—Å—å: {income_stat + expense_stat}\n"
    )
    return text


def generate_media_message(media_list, photos, text):
    if len(media_list) == 0:
        media_list.append(InputMediaPhoto(media=photos, caption=text))
    else:
        media_list.append(InputMediaPhoto(media=photos))

    return media_list


def generate_dict_for_graphics(
    history_list: List[Dict[str, Union[str, Decimal]]]
) -> Dict[str, Dict[str, Union[str, Decimal]]]:
    graph_dict_expense = {}
    graph_dict_income = {}

    for elem in history_list:
        summ = elem["amount"]
        category_name = elem["category_name"]

        if summ < 0:
            amount = -summ

            if not category_name in graph_dict_expense:
                graph_dict_expense[category_name] = amount
            else:
                graph_dict_expense[category_name] += amount
        else:
            amount = summ

            if not category_name in graph_dict_income:
                graph_dict_income[category_name] = amount
            else:
                graph_dict_income[category_name] += amount

    return {"–î–æ—Ö–æ–¥": graph_dict_income, "–†–∞—Å—Ö–æ–¥": graph_dict_expense}
